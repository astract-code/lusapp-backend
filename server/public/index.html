<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lusapp Admin - Race Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .races-list {
      margin-top: 30px;
    }

    .race-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: start;
    }

    .race-info h3 {
      color: #333;
      margin-bottom: 8px;
    }

    .race-info p {
      color: #666;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .race-actions {
      display: flex;
      gap: 10px;
    }

    .file-upload {
      border: 2px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload:hover {
      background: #f0f4ff;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÉ Lusapp Admin</h1>
    <p class="subtitle">Manage races, upload CSV files, and view all race data</p>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('add')">Add Race Manually</button>
      <button class="tab" onclick="switchTab('upload')">Upload CSV</button>
      <button class="tab" onclick="switchTab('list')">All Races</button>
    </div>

    <div id="add-tab" class="tab-content active">
      <div id="message"></div>
      <form id="race-form">
        <div class="form-group">
          <label>Race Name *</label>
          <input type="text" id="name" required>
        </div>

        <div class="form-group">
          <label>Sport *</label>
          <select id="sport" required>
            <option value="">Select Sport</option>
            <option value="Triathlon">Triathlon</option>
            <option value="Marathon">Marathon</option>
            <option value="Half Marathon">Half Marathon</option>
            <option value="Cycling">Cycling</option>
            <option value="Trail Running">Trail Running</option>
            <option value="Ultra Marathon">Ultra Marathon</option>
            <option value="Ironman">Ironman</option>
            <option value="Sprint Triathlon">Sprint Triathlon</option>
          </select>
        </div>

        <div class="form-group">
          <label>City</label>
          <input type="text" id="city">
        </div>

        <div class="form-group">
          <label>Country</label>
          <input type="text" id="country">
        </div>

        <div class="form-group">
          <label>Continent</label>
          <select id="continent">
            <option value="">Select Continent</option>
            <option value="North America">North America</option>
            <option value="South America">South America</option>
            <option value="Europe">Europe</option>
            <option value="Africa">Africa</option>
            <option value="Asia">Asia</option>
            <option value="Oceania">Oceania</option>
          </select>
        </div>

        <div class="form-group">
          <label>Date *</label>
          <input type="date" id="date" required>
        </div>

        <div class="form-group">
          <label>Distance</label>
          <input type="text" id="distance" placeholder="e.g., 42.2 km, 140.6 miles">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="description"></textarea>
        </div>

        <div class="form-group">
          <label>Number of Participants</label>
          <input type="number" id="participants" value="0" min="0">
        </div>

        <button type="submit" class="btn btn-primary">Add Race</button>
      </form>
    </div>

    <div id="upload-tab" class="tab-content">
      <div id="upload-message"></div>
      <form id="csv-form" enctype="multipart/form-data">
        <div class="file-upload" onclick="document.getElementById('csv-file').click()">
          <input type="file" id="csv-file" accept=".csv" required>
          <p style="color: #667eea; font-size: 48px; margin-bottom: 10px;">üìÅ</p>
          <p style="color: #333; font-size: 18px; margin-bottom: 5px;">Click to select CSV file</p>
          <p style="color: #666; font-size: 14px;">CSV should include: name, sport, city, country, continent, date, distance, description, participants</p>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Upload & Import</button>
      </form>
    </div>

    <div id="list-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #333; margin: 0;">All Races</h2>
        <button onclick="downloadCSV()" class="btn btn-primary" style="text-decoration: none;">
          üì• Download CSV
        </button>
      </div>
      <div id="races-list" class="races-list">
        <p style="text-align: center; color: #666;">Loading races...</p>
      </div>
    </div>
  </div>

  <script>
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');

      if (tab === 'list') {
        loadRaces();
      }
    }

    function showMessage(message, type = 'success', target = 'message') {
      const messageDiv = document.getElementById(target);
      messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => messageDiv.innerHTML = '', 5000);
    }

    document.getElementById('race-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const raceData = {
        name: document.getElementById('name').value,
        sport: document.getElementById('sport').value,
        city: document.getElementById('city').value,
        country: document.getElementById('country').value,
        continent: document.getElementById('continent').value,
        date: document.getElementById('date').value,
        distance: document.getElementById('distance').value,
        description: document.getElementById('description').value,
        participants: document.getElementById('participants').value
      };

      try {
        const response = await fetch('/api/races', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(raceData)
        });

        if (response.ok) {
          showMessage('Race added successfully!');
          document.getElementById('race-form').reset();
        } else {
          showMessage('Error adding race', 'error');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
      }
    });

    document.getElementById('csv-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('csv-file');
      if (!fileInput.files[0]) {
        showMessage('Please select a CSV file', 'error', 'upload-message');
        return;
      }

      const formData = new FormData();
      formData.append('csvFile', fileInput.files[0]);

      try {
        const response = await fetch('/api/races/csv-upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        if (response.ok) {
          showMessage(`Successfully imported ${result.imported} out of ${result.total} races!`, 'success', 'upload-message');
          fileInput.value = '';
        } else {
          showMessage('Error uploading CSV: ' + result.error, 'error', 'upload-message');
        }
      } catch (error) {
        showMessage('Error: ' + error.message, 'error', 'upload-message');
      }
    });

    async function loadRaces() {
      try {
        const response = await fetch('/api/races');
        const races = await response.json();
        
        const listDiv = document.getElementById('races-list');
        if (races.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; color: #666;">No races found. Add some races to get started!</p>';
          return;
        }

        listDiv.innerHTML = races.map(race => `
          <div class="race-card">
            <div class="race-info">
              <h3>${race.name}</h3>
              <p><strong>Sport:</strong> ${race.sport}</p>
              <p><strong>Location:</strong> ${race.city ? race.city + ', ' : ''}${race.country || 'N/A'}</p>
              <p><strong>Date:</strong> ${new Date(race.date).toLocaleDateString()}</p>
              <p><strong>Distance:</strong> ${race.distance || 'N/A'}</p>
              <p><strong>Participants:</strong> ${race.participants || 0}</p>
            </div>
            <div class="race-actions">
              <button class="btn btn-danger" onclick="deleteRace(${race.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading races:', error);
      }
    }

    async function deleteRace(id) {
      if (!confirm('Are you sure you want to delete this race?')) return;

      try {
        const response = await fetch(`/api/races/${id}`, { method: 'DELETE' });
        if (response.ok) {
          loadRaces();
        }
      } catch (error) {
        alert('Error deleting race: ' + error.message);
      }
    }

    async function downloadCSV() {
      try {
        const response = await fetch('/api/races/csv-download', {
          credentials: 'include'
        });
        
        if (!response.ok) {
          alert('Error downloading CSV. Please try again.');
          return;
        }

        // Get the CSV content
        const blob = await response.blob();
        
        // Create a download link and trigger it
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lusapp-races-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        alert('Error downloading CSV: ' + error.message);
      }
    }
  </script>
</body>
</html>
